#! /usr/bin/env bqn

crâ€¿lf â† @+13â€¿10
Log â† â€¢term.ErrRaw
Logln â† Log âˆ¾âŸœlf

# Codepoint to UTF-8
cpToUTF8 â† {
    Cnt â† 128 + 64âŠ¸|    # make continuation byte
    Shr â† âŒŠ âŠ¢ Ã· â‹†ËœâŸœ2    # ğ•© >> ğ•¨
    {
        ğ•© < 2â‹† 7? âŸ¨             ğ•©                                  âŸ© ;
        ğ•© < 2â‹†11? âŸ¨192 +  6 Shr ğ•©,                            Cnt ğ•©âŸ© ;
        ğ•© < 2â‹†16? âŸ¨224 + 12 Shr ğ•©,               Cnt 6 Shr ğ•©, Cnt ğ•©âŸ© ;
                  âŸ¨240 + 18 Shr ğ•©, Cnt 12 Shr ğ•©, Cnt 6 Shr ğ•©, Cnt ğ•©âŸ©
    }
}
ToUTF8 â† âˆ¾ Â· CpToUTF8Â¨ -âŸœ@
! 226â€¿138â€¿145â€¿240â€¿157â€¿149â€¿168â€¿47â€¿240â€¿157â€¿149â€¿169 â‰¡ ToUTF8 "âŠ‘ğ•¨/ğ•©"    # [*"âŠ‘ğ•¨/ğ•©".encode('utf-8')]

# https://github.com/dzaima/CBQN/blob/master/docs/system.md#term
SendUTF8 â† {
    "sending more than 512 bytes" ! 510 â‰¥ â‰ ğ•©
    Logln (Time@)âˆ¾">>> "âˆ¾ğ•©
    â€¢term.OutRaw ğ•©âˆ¾crâ€¿lf
    â€¢term.Flush @
}
Send â† SendUTF8âˆ˜ToUTF8

IRCParse â† { ğ•Š in:
    in Â¬âˆ˜(âˆ§`âŒ¾âŒ½âˆŠâŸœcrâ€¿lf)âŠ¸/â†©
    clnâ†Â»âŠ¸<âˆ¨`(Â»spc)âˆ§âŠ‘Â·â€¿spcâ†inâŠ¸=Â¨": "
    2(â†‘âˆ¾âŸœ<â†“)inâŠ”Ëœ(-+Â¬Ã—(Â¯1âŠ¸âˆ¨âŒ¾âŠ‘(':'â‰ âŠ‘in)â¥ŠËœâ‰¢)+cln+âŒ¾âŠ‘âŒ¾âŒ½Â·+`Â»âŠ¸<) 0âˆ¾Ëœclnâˆ¨spcâˆ§Â¬âˆ¨`cln
}
! "pig"â€¿"PRIVMSG"â€¿("#a"â€¿":  bee sus") â‰¡ IRCParse ":pig PRIVMSG  #a  ::  bee sus"âˆ¾crâ€¿lf
! ""â€¿"pig"â€¿("PRIVMSG"â€¿"#a"â€¿"among"â€¿"us") â‰¡ IRCParse "pig PRIVMSG  #a    among us"
! "irc.example.com"â€¿"CAP"â€¿("*"â€¿"LIST"â€¿"") â‰¡ IRCParse ":irc.example.com CAP * LIST :"âˆ¾(10/â‹ˆcr)âˆ¾lf
! "AutoBotRobot"â€¿"PRIVMSG"â€¿("#b"â€¿"<9DrakeBot> :tada: Congratulations to") â‰¡ {
    IRCParse ":AutoBotRobot PRIVMSG #b :<9DrakeBot> :tada: Congratulations to"
}

alternatives â† "piglet"â€¿"hog"â€¿"swine"â€¿"pork"â€¿"shoat"â€¿"boar"â€¿"sow"â€¿"suid"â€¿"farrow"â€¿"boneen"
name â† "pig"
lastreq â† 0

OnMessage â† {
    # this is not actually an irc command. it is sent by the shell file to tell this file to send
    # the login commands and stuff
    ğ•Š Â·â€¿"STARTPLZ"â€¿Â·:
        SendÂ¨ ("NICK "âˆ¾name)â€¿("USER "âˆ¾nameâˆ¾" 0 * :"âˆ¾(@+29)âˆ¾"Sus domesticus")
    ;
    ğ•Š Â·â€¿"433"â€¿Â·: Send   "NICK "âˆ¾nameâ†©Pick alternatives ;                # ERR_NICKNAMEINUSE
    ğ•Š Â·â€¿"001"â€¿Â·: SendÂ¨ ("MODE "âˆ¾nameâˆ¾" +x")â€¿"JOIN #b"â€¿"PRIVMSG #b ğŸ–" ; # RPL_WELCOME
    ğ•Š Â·â€¿"PING"â€¿args: Send args (âŠ¢âˆ¾" :"âˆ¾Â¯1âŠ‘âŠ£)âŸ(0â‰ â‰ âˆ˜âŠ£) "PONG" ;
    ğ•Š srcâ€¿"PRIVMSG"â€¿(chanâ€¿msg):
    âˆ¨Â´ pigs â† nameâ·â—‹(âˆ¾âŸœ' ')msg?
        nameâ€¿args â† âŠ‘âˆ˜âŠâŸœ' 'âŠ¸(â†‘â‹ˆ1âŠ¸+âŠ¸â†“) msg â†“Ëœ 1+ (â‰ name) + âŠ‘/pigs
        {srcâ‡src,chanâ‡chan,argsâ‡args} DelayedDoCommandâŠ({
            ğ•¨ Say "*vomits on ground*" â‹„ Logln "!!! "âˆ¾ğ•©
        }âŸœâ€¢CurrentError) name
    ; @
}

# send lines of around `bytes` bytes, without splitting utf-8 sequence boundaries
Saylns â† {
    bytes â† 420    # maximum bytes to send
    utf â† CpToUTF8âˆ˜-âŸœ@Â¨ 'â¡'âŸ((@+127)âŠ¸=)Â¨ +âŸœ(('â€'-@)Ã—' 'âŠ¸> âˆ§ lfâŠ¸â‰ ) ğ•©
    lines â† âˆ¾Â¨ utf âŠ”Ëœ bytes âŒŠâˆ˜Ã·Ëœ 0 (10=âŠ‘âˆ˜âŠ¢)â—¶âŸ¨+âŸœâ‰ ,âŒˆâŒ¾(Ã·âŸœbytes)âŠ£âŸ©` utf
    lines (âˆ¾âŸœâŸ¨ToUTF8"etc"âŸ© 10âŠ¸â†‘)âŸ(10<â‰ lines)â†©
    SendUTF8âˆ˜(10âŠ¸â‰ âŠ¸/ (ToUTF8 ResponsePrefix ğ•¨)âˆ¾âŠ¢)Â¨ lines
}

ResponsePrefix â† "PRIVMSG "âˆ¾{ğ•©.chanâ‰¡"pig"? âŠ‘âˆ˜âŠâŸœ'!'âŠ¸â†‘ ğ•©.src; ğ•©.chan}âˆ¾" :"Ë™

Say â† Send ResponsePrefixâŠ¸âˆ¾

susBQN â† â€¢ReBQN {replâ‡"loose",scopeâ‡"none"}
# provide some builtins
SusBQN âˆ¾ (âŠ¢âˆ¾"â†â€¢"âˆ¾âˆ¾âŸœlf)Â¨ "rand"â€¿"math"â€¿"Fmt"â€¿"Repr"â€¿"Type"â€¿"Glyph"â€¿"Decompose"â€¿"MakeRand"â€¿"ParseFloat"

keyfm â† "`123456890-=~!@#$%^&*()_+qwertuiop[]QWERTIOP{}asdfghjkl;ASFGHKL:zxcvbm,./ZXVBM<>? '\"""
keyto â† "ËœË˜Â¨â¼âŒœÂ´ËâˆÂ¯â€¢Ã·Ã—Â¬â‰âš‡âŸâ—¶âŠ˜âŠââ•âŸ¨âŸ©âˆšâ‹†âŒ½ğ•¨âˆŠâ†‘âˆ§âŠ”âŠâŠÏ€â†â†’â†™ğ•â·ğ•£â‹âŠ‘âŠ’â³âŠ£âŠ¢â‰ğ•¤â†•ğ•—ğ•˜âŠ¸âˆ˜â—‹âŸœâ‹„â†–ğ•Šğ”½ğ”¾Â«âŒ¾Â»Â·â¥Šğ•©â†“âˆ¨âŒŠâ‰¡âˆ¾â‰â‰ â‹ˆğ•â’âŒˆâ‰¢â‰¤â‰¥â‡â€¿â†©\Ë™ğŸ–"

Detick â† (âŒŠâ—‹(âŠ‘âŠâŸœ0)âŸœâŒ½ '`'âŠ¸=)âŠ¸(âŠ£â†“-âŠ¸â†“)    # removes as many backticks as possible

Unescape â† (<`'\'âŠ¸=)âŠ¸{(Â¬ğ•¨)/(âŠâŸœkeyto keyfmâŠ¸âŠ)âŒ¾((Â»ğ•¨)âŠ¸/)ğ•©}    # resolves BQN escapes

Pick â† (â€¢rand.Rangeâˆ˜â‰  âŠ‘ âŠ¢)âŠ˜(â€¢rand.RangeâŸœâ‰  âŠ âŠ¢)

DelayedDoCommand â† {
    cx ğ•Š Â·: 0.5 > (â€¢MonoTime@) - lastreq? cx Say "wait!!!";
    ğ•¨ DoCommand ğ•© â‹„ lastreq â†© â€¢MonoTime@
}

DoCommand â† {
    cx ğ•Š "say": cx Say cx.args;
    cx ğ•Š "do":
        code â† '#'âŸ('â'âŠ¸=)Â¨ 'â€¢'âŠ¸â‰ âŠ¸/ Unescape Detick cx.args
        ! Â¬âŠ‘'â€¢'âˆŠcode    # this should NOT happen  # glad to know past me knew what an assertion was
        { âŠ‘"#" âˆŠ ğ•©? cx Say "nah" â‹„ "emetion triggered" ! 0 ;
            cx Saylns {1==ğ•©? âˆ§Â´2=â€¢TypeÂ¨ğ•©? ğ•©; â€¢Fmtğ•©}âˆ˜SusBQNâŠ("Error: "âˆ¾â€¢CurrentError) ğ•©
        } code
    ;
    cx ğ•Š "perform": cxâŠ¸DoCommandÂ¨ "unescape"â€¿"do";
    cx ğ•Š "rewrite": cx Saylns "```"(âˆ¾âˆ¾âŠ£) 1âŠ‘â€¢SH "vemf"â€¿"-r"â€¿"-e"â€¿(Detick cx.args) ;
    cx ğ•Š cmd: "act"â‰¡3â†‘cmd ?
        cx Saylns (-lf=âŠ¢Â´)âŠ¸â†“ 1âŠ‘â€¢SH "timeout"â€¿"10s"â€¿"vemf"â€¿"-f"â€¿("1"âŸ(Â¬â‰ )3â†“cmd)â€¿"-e"â€¿(Detick cx.args)
    ;
    cx ğ•Š cmd: "react"â‰¡5â†‘cmd ? cxâŠ¸DoCommandÂ¨"rewrite"â‹ˆ2â†“cmd ;
    cx ğ•Š "unescape": cx Saylns "```"(âˆ¾âˆ¾âŠ£) Unescape Detick cx.args ;
    cx ğ•Š "join": Â¬âˆ¨Â´","âˆŠcx.args? '#'=âŠ‘cx.args? cx Say "omw" â‹„ Send "JOIN "âˆ¾cx.args ;
    cx ğ•Š "leave": cx Say "omw" â‹„ Send "PART "âˆ¾cx.chan ;
    cx ğ•Š "emete": "emetion triggered" ! 0 ;
    cx ğ•Š "please":
        nameâ€¿args â† âŠ‘âˆ˜âŠâŸœ' 'âŠ¸(â†‘â‹ˆ1âŠ¸+âŠ¸â†“) cx.args
        {srcâ‡cx.src, chanâ‡cx.chan, argsâ‡args} DoCommand name
        cx Say âˆ¾ PickÂ¨ âŸ¨
            âŸ¨"my pleasure"
             "forget it"
             "not at all"
             "yw"
             "np"âŸ© âˆ¾ 2/âŸ¨"you're welcome"
                        "no problem"
                        "it's nothing"
                        "it's a pleasure"
                        "no worries"âŸ©
            âŸ¨"!!"âŸ© âˆ¾ 2/"!"â€¿""
            " :D"â€¿" :>"â€¿" :]" âˆ¾ 2/" c:"â€¿" :)"â€¿""
        âŸ©
    ;
    cx ğ•Š "aysay":
        ltrs â† âˆ¾ "Aa"âŠ¸+Â¨â†•26
        cx Saylns âˆ¾{
            (âˆ¾âˆ¾"ay"âˆ¾Ëœ"w"/Ëœ2-â‰ )ğ•©âŠ”Ëœâˆ§` (0âˆ¾"qu"â·ğ•©)âˆ¨ 1âŒ¾âŠ‘âŸ(('y'=âŠ‘ğ•©)âˆ§Â·Â¬1âŠ‘âˆ¾âŸœ0) Â¬ğ•©âˆŠ"aeiouy"
        }âŸ(âŠ‘1="a{"â‹âŠ¢)Â¨ (+`Â·âˆ¨âŸœÂ» 1â‰ "a{"â‹âŠ¢)âŠ¸âŠ” (32Ã—1="A["â‹âŠ¢)âŠ¸+ cx.args
    ;
    cx ğ•Š "bee":
        Num â† {ğ•¤â‹„ âŒŠ 1024 Ã· 10+â€¢rand.Range 256}
        cx Saylns âˆ¾ {ğ•@}Â¨ (Num @) Pick âˆ¾ âŸ¨
            3/âŸ¨{ğ•¤â‹„ "bee"âˆ¾(NumâŠ¸/ "e")âˆ¾(Pick ""â€¿""â€¿"s")âˆ¾(NumâŠ¸/ "!")âˆ¾Pick""â€¿" "â€¿" "}âŸ©
            3/âŸ¨{ğ•¤â‹„ "bzz"âˆ¾(NumâŠ¸/ "z")âˆ¾(Pick ""â€¿"t")âˆ¾(Pick ""â€¿"!")âˆ¾Pick""â€¿" "â€¿" "}âŸ©
              âŸ¨{ğ•¤â‹„ "c:"  âˆ¾Pick""â€¿" "}âŸ©
              âŸ¨{ğ•¤â‹„ "apio"âˆ¾Pick""â€¿" "}âŸ©
        âŸ©
    ;
    cx ğ•Š "help": cx Say "i can "âˆ¾Pick âŸ¨
        "say","do","perform","rewrite","react","unescape","join","leave","emete","please"
        "aysay","bee","help","oink"âŸ© ;
    cx ğ•Š cmd: cx Say "oink"
}
Time â† {ğ•¤â‹„ Â¯1â†“1âŠ‘â€¢SH "date"â€¿"-u"â€¿"+%H:%M:%S"}

Main â† {ğ•¤
    Logln "starting..."
    {ğ•¤
        { Logln (Time@)âˆ¾"... "âˆ¾(@+8203)âŠ¸â‰ âŠ¸/ ğ•© â‹„ OnMessage IRCParse ğ•© } â€¢GetLine @
    } â€¢_while_ 1 @
}


MainâŸ{ğ•¤â‹„"run"â‰¡âŠ‘â€¢args}âŸ(1â‰¤â‰ â€¢args) @
