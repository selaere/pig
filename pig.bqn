#! /usr/bin/env bqn

crâ€¿lf â† @+13â€¿10

fmtItalics â† @+29

Log â† â€¢term.ErrRaw
Logln â† Log âˆ¾âŸœlf

# Codepoint to UTF-8
cpToUTF8 â† {
    Cnt â† 128 + 64âŠ¸|    # make continuation byte
    Shr â† âŒŠ âŠ¢ Ã· â‹†ËœâŸœ2    # ğ•© >> ğ•¨
    {
        ğ•© < 2â‹† 7? âŸ¨             ğ•©                                  âŸ© ;
        ğ•© < 2â‹†11? âŸ¨192 +  6 Shr ğ•©,                            Cnt ğ•©âŸ© ;
        ğ•© < 2â‹†16? âŸ¨224 + 12 Shr ğ•©,               Cnt 6 Shr ğ•©, Cnt ğ•©âŸ© ;
                  âŸ¨240 + 18 Shr ğ•©, Cnt 12 Shr ğ•©, Cnt 6 Shr ğ•©, Cnt ğ•©âŸ©
    }
}
ToUTF8 â† âˆ¾ Â· CpToUTF8Â¨ -âŸœ@
! 226â€¿138â€¿145â€¿240â€¿157â€¿149â€¿168â€¿47â€¿240â€¿157â€¿149â€¿169 â‰¡ ToUTF8 "âŠ‘ğ•¨/ğ•©"    # [*"âŠ‘ğ•¨/ğ•©".encode('utf-8')]

# https://github.com/dzaima/CBQN/blob/master/docs/system.md#term
SendUTF8 â† {
    "sending more than 512 bytes" ! 510 â‰¥ â‰ ğ•©
    Logln ">>> "âˆ¾ğ•©
    â€¢term.OutRaw ğ•©âˆ¾crâ€¿lf
    â€¢term.Flush @
}
Send â† SendUTF8âˆ˜ToUTF8

IRCParse â† { ğ•Š in: 
    in â†“Ëœâ†© - âŠ‘âŠâŸœ0 âŒ½ (crâŠ¸= âˆ¨ lfâŠ¸=) in    # remove line endings
    spcâ€¿cln â† inâŠ¸=Â¨ " :"
    cln â†© Â¬ âŸ¨1âŸ©âŠ’ 0 Â» spc âˆ§ 0Â«cln    # keep only when followed by spaces
    wds â† (Ã—â‰ Â¨)âŠ¸/ in âŠ”Ëœ (âŠ¢ -Ëœ Â¬ âˆ§ +`) clnâˆ¨ spcâˆ§ Â¬âˆ¨`cln    # strips colons too!
    wds âˆ¾âŸœâŸ¨""âŸ©âŸ(Â¯1 âŠ‘ cln)â†©    # if the colon is at the end, add an empty argument
    src â† ""
    {ğ•Š: src â†© 1 â†“ âŠ‘wds
        wds â†“Ëœâ†© 1}âŸâŠ¢ ':' = âŠ‘in
    âŸ¨src, âŠ‘ wds, 1 â†“ wdsâŸ©    # srcâ€¿nameâ€¿args
}
! "pig"â€¿"PRIVMSG"â€¿("#a"â€¿":  bee sus") â‰¡ IRCParse ":pig PRIVMSG  #a  ::  bee sus"âˆ¾crâ€¿lf
! ""â€¿"pig"â€¿("PRIVMSG"â€¿"#a"â€¿"among"â€¿"us") â‰¡ IRCParse "pig PRIVMSG  #a    among us"
! "irc.example.com"â€¿"CAP"â€¿("*"â€¿"LIST"â€¿"") â‰¡ IRCParse ":irc.example.com CAP * LIST :"âˆ¾(10/â‹ˆcr)âˆ¾lf
! "AutoBotRobot"â€¿"PRIVMSG"â€¿("#b"â€¿"<9DrakeBot> :tada: Congratulations to") â‰¡ {
    IRCParse ":AutoBotRobot PRIVMSG #b :<9DrakeBot> :tada: Congratulations to"
}

alternatives â† "piglet"â€¿"hog"â€¿"swine"â€¿"pork"â€¿"shoat"â€¿"boar"â€¿"sow"â€¿"shoat"â€¿"suid"â€¿"farrow"â€¿"boneen"

name â† "pig"

ParseCommand â† âŠ‘âˆ˜âŠâŸœ' ' âŠ¸ (â†‘ â‹ˆ 1âŠ¸+âŠ¸â†“)

OnMessage â† {
    ğ•Š Â·â€¿"STARTPLZ"â€¿Â·:
        # this is not actually an irc command. it is sent by the shell file to tell this file to 
        # send the login commands and shit
        Send "NICK "âˆ¾name
        Send "USER "âˆ¾nameâˆ¾" 0 * :"âˆ¾fmtItalicsâˆ¾"Sus domesticus"
    ;
    ğ•Š Â·â€¿"433"â€¿Â·:    # ERR_NICKNAMEINUSE
        name â†© Pick alternatives
        Send "NICK "âˆ¾name
    ;
    ğ•Š Â·â€¿"001"â€¿Â·:    # RPL_WELCOME
        Send "MODE "âˆ¾nameâˆ¾" +x"
        Send "JOIN #b"
        Send "PRIVMSG #b ğŸ–"
    ;
    ğ•Š Â·â€¿"PING"â€¿args:
        Send {0=â‰ args? "PONG" ; "PONG :"âˆ¾Â¯1âŠ‘args}
    ;
    ğ•Š srcâ€¿"PRIVMSG"â€¿(chanâ€¿msg):
    âˆ¨Â´ pigs â† (nameâˆ¾" ") â· " " âˆ¾Ëœ msg?
        nameâ€¿args â† ParseCommand msg â†“Ëœ (1+â‰ name) + âŠ‘/pigs
        {srcâ‡src,chanâ‡chan,argsâ‡args} DoCommandâŠ({
            ğ•¨ Say "*vomits on ground*"
            Logln "!!! "âˆ¾ğ•©
        }âŸœâ€¢CurrentError) name
    ; @
}

# send lines of around `bytes` bytes, without splitting utf-8 sequence boundaries
Saylns â† {
    bytes â† 420    # maximum bytes to send
    utf â† CpToUTF8âˆ˜-âŸœ@Â¨ ğ•© 
    lines â† utf âŠ”Ëœ bytes âŒŠâˆ˜Ã·Ëœ 0 {âŸ¨ğ•¨+â‰ ğ•©, âŒˆâŒ¾(Ã·âŸœbytes) ğ•¨âŸ© âŠ‘Ëœ 10=âŠ‘ğ•©}` utf
    SendUTF8âˆ˜(10âŠ¸â‰ âŠ¸/ (ToUTF8 ResponsePrefix ğ•¨) âˆ¾ âˆ¾)Â¨ lines
}

ResponsePrefix â† " :"âˆ¾Ëœ"PRIVMSG "âˆ¾{ğ•©.chanâ‰¡"pig"? âŠ‘âˆ˜âŠâŸœ'!' âŠ¸ â†‘ ğ•©.src; ğ•©.chan}

Say â† Send  âŠ¢ âˆ¾Ëœ ResponsePrefixâˆ˜âŠ£

susBQN â† â€¢ReBQN {replâ‡"loose",scopeâ‡"none"}
# provide some builtins
SusBQN âˆ¾ (âŠ¢ âˆ¾ "â†â€¢" âˆ¾ âˆ¾âŸœlf)Â¨ "rand"â€¿"math"â€¿"Fmt"â€¿"Repr"â€¿"Type"â€¿"Glyph"â€¿"Decompose"â€¿"MakeRand"â€¿"bit"

keyfm â† "`123456890-=~!@#$%^&*()_+qwertuiop[]QWERTIOP{}asdfghjkl;ASFGHKL:zxcvbm,./ZXVBM<>? '\"""
keyto â† "ËœË˜Â¨â¼âŒœÂ´ËâˆÂ¯â€¢Ã·Ã—Â¬â‰âš‡âŸâ—¶âŠ˜âŠââ•âŸ¨âŸ©âˆšâ‹†âŒ½ğ•¨âˆŠâ†‘âˆ§âŠ”âŠâŠÏ€â†â†’â†™ğ•â·ğ•£â‹âŠ‘âŠ’â³âŠ£âŠ¢â‰ğ•¤â†•ğ•—ğ•˜âŠ¸âˆ˜â—‹âŸœâ‹„â†–ğ•Šğ”½ğ”¾Â«âŒ¾Â»Â·â¥Šğ•©â†“âˆ¨âŒŠâ‰¡âˆ¾â‰â‰ â‹ˆğ•â’âŒˆâ‰¢â‰¤â‰¥â‡â€¿â†©\Ë™ğŸ–"
# ğŸ– will be used when no escape is found

# resolves BQN escapes as in https://mlochbaum.github.io/BQN/keymap.html
Unescape â† {
    code â† ğ•© (âŠ£ â†“ -âŠ¸â†“)Ëœ (âŠ‘âˆ˜âŠâŸœ0 âŒŠ âŠ‘âˆ˜âŠâŸœ0âˆ˜âŒ½) '`' = ğ•©   # removes as many ticks it can
    bsls â† Â¬âŠ¸âˆ¨` '\' â‰  code    # in \\ only the first backslash should be escaped
    bsls / (keyto âŠËœ keyfm âŠ âŠ¢)âŒ¾((Â»Â¬bsls)âŠ¸/) code
}

Pick â† â€¢rand.Rangeâˆ˜â‰  âŠ‘ âŠ¢

DoCommand â† {
    cx ğ•Š "say":
        cx Say cx.args
    ;
    cx ğ•Š "do":
        code â† '#'âŸ('â'âŠ¸=)Â¨ ('â€¢'âŠ¸â‰  / âŠ¢) Unescape cx.args
        ! Â¬âŠ‘ 'â€¢' âˆŠ code    # this should NOT happen
        cx Saylns {1 = =ğ•©? âˆ§Â´ 2 = â€¢TypeÂ¨ ğ•©? ğ•©; â€¢Fmt ğ•©}âˆ˜SusBQNâŠ("Error: "âˆ¾â€¢CurrentError) code
    ;
    cx ğ•Š "perform":
        cx DoCommand "unescape"
        cx DoCommand "do"
    ;
    cx ğ•Š "unescape":
        cx Saylns ("```"âŠ¸âˆ¾âˆ¾âŸœ"```") Unescape cx.args
    ;
    cx ğ•Š "join": Â¬ âˆ¨Â´ " ," âˆŠ cx.args? '#' = âŠ‘ cx.args?
        cx Say "omw"
        Send "JOIN "âˆ¾cx.args
    ;
    cx ğ•Š "leave":
        cx Say "omw"
        Send "PART "âˆ¾cx.chan
    ;
    cx ğ•Š "emete":
        "emetion triggered" ! 0
    ;
    cx ğ•Š "please":
        nameâ€¿args â† ParseCommand cx.args
        {srcâ‡ cx.src, chanâ‡ cx.chan, argsâ‡ args} DoCommand name
        cx Say âˆ¾ PickÂ¨ âŸ¨
            âŸ¨"my pleasure"
             "forget it"
             "not at all"
             "yw"
             "np"âŸ©âˆ¾ 2/âŸ¨"you're welcome"
                       "no problem"
                       "it's nothing"
                       "it's a pleasure"
                       "no worries"âŸ©
            âŸ¨"!!"âŸ© âˆ¾ 2/"!"â€¿""
            " :D"â€¿" :>"â€¿" :]" âˆ¾ 2/" c:"â€¿" :)"â€¿""
        âŸ©
    ;
    cx ğ•Š "aysay":
        ltrs â† âˆ¾ "Aa"âŠ¸+Â¨â†•26
        csnts â† "bcdfghjklmnpqrstvwxz"
        cx Saylns âˆ¾ {
            0 = â‰ ğ•©? "";
            Â¬âŠ‘ ğ•© âˆŠ ltrs? ğ•©;
            wd â† +âŸœ(32Ã—'Z'âŠ¸â‰¥)Â¨ ğ•©
            t â† âŠ‘âŠâŸœ0 (0âˆ¾"qu"â·wd)âˆ¨ 1âŒ¾âŠ‘âŸ('y'=âŠ‘wd) wd âˆŠ csnts
            (tâ†“wd) âˆ¾ (tâ†‘wd) âˆ¾ ("w"/Ëœt=0) âˆ¾ "ay"
        }Â¨ cx.args âŠ”Ëœ +` (âŠ¢ âˆ¨ 1Â»âŠ¢) Â¬ ltrs âˆŠËœ cx.args
    ;
    cx ğ•Š "bee":
        Number â† {ğ•Š: âŒŠ 1024 Ã· 10+â€¢rand.Range 256}
        Repeat â† NumberâŠ¸/
        choices â† âˆ¾ âŸ¨
            3/âŸ¨{ğ•Š: "bee"âˆ¾(Repeat "e")âˆ¾(Pick ""â€¿""â€¿"s")âˆ¾(Repeat "!")}âŸ©
            3/âŸ¨{ğ•Š: "bzz"âˆ¾(Repeat "z")âˆ¾(Pick ""â€¿"t")âˆ¾(Pick ""â€¿"!")}âŸ©
              âŸ¨"c:"âŸ©
              âŸ¨"apio"âŸ©
        âŸ©
        cx Saylns {ğ•Š: ğ•© âˆ¾ âˆ¾âŸœ' 'âŸ(7â‰¥â€¢rand.Range 10) (Pick choices){ğ”½} 1 }âŸNumber âŸ¨âŸ©
    ;
    cx ğ•Š cmd:
        cx Say "oink"
}

Main â† {ğ•Š:
    Logln "starting..."
    { ğ•Š:
        Log "... "
        (OnMessageâˆ˜IRCParse @Ë™ Logln) â€¢GetLine @
    } â€¢_while_ 1 @
}


MainâŸ{ğ•Š:"run"â‰¡âŠ‘â€¢args}âŸ(1â‰¤â‰ â€¢args) @